// This Vercel function handles the final stage of the Discord OAuth flow.
// It exchanges the temporary code for tokens, fetches user data, and POSTs
// the result to your running Python bot's web server.

const { URLSearchParams } = require('url');

// --- Configuration loaded from Vercel Environment Variables ---
// You MUST set these variables in your Vercel project settings (Settings > Environment Variables)
const CLIENT_ID = process.env.1441543647341314123;
const CLIENT_SECRET = process.env.MYqAOvGSIH9ap4JWHXEPwB5ggbY41B8C;
const REDIRECT_URI = process.env.https://sparx-members-bot-2.vercel.app; 
// CRITICAL: This is the environment variable that MUST contain your full Katabump address.
// Example value: 51.75.118.18:20228
const BOT_HOST_IP = process.env.BOT_HOST_IP; 

const DISCORD_API_BASE = 'https://discord.com/api/v10';

// Simple HTML template for the final page displayed to the user
const htmlTemplate = (status, title, message) => `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${title}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="max-w-md w-full p-8 bg-white rounded-xl shadow-2xl">
        <div class="text-center">
            ${status === 'success' 
                ? '<svg class="mx-auto h-12 w-12 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
                : '<svg class="mx-auto h-12 w-12 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
            }
            <h1 class="mt-4 text-2xl font-bold text-gray-900">${title}</h1>
            <p class="mt-2 text-gray-600">${message}</p>
        </div>
        <div class="mt-6">
            <a href="https://discord.com/" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Return to Discord
            </a>
        </div>
    </div>
</body>
</html>
`;

// Main handler for the Vercel function
module.exports = async (req, res) => {
    // 1. Check for required environment variables
    if (!CLIENT_ID || !CLIENT_SECRET || !REDIRECT_URI || !BOT_HOST_IP) {
        return res.status(500).send(htmlTemplate(
            'error', 
            'Configuration Error', 
            'The Vercel environment variables (CLIENT_ID, CLIENT_SECRET, REDIRECT_URI, or BOT_HOST_IP) are not set. Contact the bot administrator.'
        ));
    }

    const { code } = req.query;

    if (!code) {
        return res.status(400).send(htmlTemplate(
            'error', 
            'Access Denied', 
            'No authorization code was provided by Discord. You must click "Authorize".'
        ));
    }

    let tokenResponse;
    let userResponse;
    
    // --- Phase 1: Exchange Code for Tokens ---
    try {
        const params = new URLSearchParams({
            client_id: CLIENT_ID,
            client_secret: CLIENT_SECRET,
            grant_type: 'authorization_code',
            code: code,
            redirect_uri: REDIRECT_URI,
            scope: 'identify guilds.join' 
        });

        tokenResponse = await fetch(`${DISCORD_API_BASE}/oauth2/token`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params
        });

        if (!tokenResponse.ok) {
            const errorText = await tokenResponse.text();
            throw new Error(`Token Exchange Failed (${tokenResponse.status}): ${errorText}`);
        }

        tokenResponse = await tokenResponse.json();

    } catch (e) {
        console.error('Token Exchange Error:', e.message);
        return res.status(500).send(htmlTemplate(
            'error', 
            'OAuth Error', 
            'Failed to exchange authorization code for tokens. Check CLIENT_ID/SECRET and REDIRECT_URI configuration in Discord and Vercel.'
        ));
    }

    // --- Phase 2: Fetch User Identity ---
    try {
        userResponse = await fetch(`${DISCORD_API_BASE}/users/@me`, {
            headers: { Authorization: `Bearer ${tokenResponse.access_token}` }
        });

        if (!userResponse.ok) {
            const errorText = await userResponse.text();
            throw new Error(`User Fetch Failed (${userResponse.status}): ${errorText}`);
        }

        userResponse = await userResponse.json();

    } catch (e) {
        console.error('User Fetch Error:', e.message);
        return res.status(500).send(htmlTemplate(
            'error', 
            'User Data Error', 
            'Failed to retrieve your Discord profile. Check the OAuth scopes.'
        ));
    }

    // --- Phase 3: Send Tokens to Python Bot (CRITICAL STEP) ---
    const botUrl = `http://${BOT_HOST_IP}/save_token`; // Use http for local network/direct IP connection

    const tokenPayload = {
        user_id: userResponse.id,
        username: `${userResponse.username}#${userResponse.discriminator || '0'}`, // Include discriminator if present
        access_token: tokenResponse.access_token,
        refresh_token: tokenResponse.refresh_token,
        expires_in: tokenResponse.expires_in,
        scopes: tokenResponse.scope,
    };
    
    try {
        const botResponse = await fetch(botUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(tokenPayload)
        });

        if (!botResponse.ok) {
            const errorText = await botResponse.text();
            throw new Error(`Bot Save Failed (${botResponse.status}): ${errorText}`);
        }
        
        // Final success page
        return res.status(200).send(htmlTemplate(
            'success', 
            'âœ… Access Granted!', 
            `Welcome, ${userResponse.username}! Your authorization is saved. The server admin can now add you using the /join command.`
        ));

    } catch (e) {
        console.error('Bot Connection/Save Error:', e.message);
        // Display the specific network error to the user to help debug the IP/Port/Firewall
        return res.status(500).send(htmlTemplate(
            'error', 
            'Critical Network Error', 
            `Failed to save data to your bot server at ${BOT_HOST_IP}. Reason: ${e.message}. This usually means the IP, port, or firewall is incorrect.`
        ));
    }
};
